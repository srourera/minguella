<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>CSV Parser</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div id="app">
      <h1>CSV Parser</h1>
      <button @click="load" :disabled="loading">
        {{ loading ? 'Cargando...' : 'Cargar CSV' }}
      </button>

      <div v-if="error" style="color: red; margin: 10px 0">
        Error: {{ error }}
      </div>

      <div v-if="parsedData.length">
        <h3>Datos parseados ({{ parsedData.length }} registros):</h3>
        <pre>{{ JSON.stringify(parsedData, null, 2) }}</pre>
      </div>
    </div>

    <!-- PapaParse para CSV robusto -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Vue 3 por CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
      const { createApp } = Vue;

      // ðŸ”§ Sustituye por tu Sheet y pestaÃ±a
      const SHEET_ID = "1fkCpZgF1BCl-_lOsB4O-MGofvkw6NBYAUIGd3aYWOyI";
      const GID = "0";
      const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

      // Utilidades
      const parsePrice = (v) => {
        if (v == null) return 0;
        const s = String(v).trim().replace(/[â‚¬\s]/g, "").replace(",", ".");
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : 0;
      };

      const normalizeHeader = (s) =>
        String(s || "")
          .trim()
          .toLowerCase();

      const parseDate = (v) => {
        if (!v) return "";
        const s = String(v).trim();
        // Soporta "YYYY-MM-DD", "DD/MM/YYYY", "MM/DD/YYYY"
        const m1 = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m1) return s.slice(0, 10);
        const m2 = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (m2) {
          const [_, d, mo, y] = m2;
          return `${y}-${mo}-${d}`;
        }
        const d = new Date(s);
        if (!isNaN(d)) return d.toISOString().slice(0, 10);
        return s;
      };

      function rowsToObjects(papaResult) {
        const rows = papaResult.data || [];
        if (!rows.length) return [];
        const headerMap = {};
        Object.keys(rows[0]).forEach((k) => {
          headerMap[normalizeHeader(k)] = k;
        });

        const get = (row, logical) => row[headerMap[logical]] ?? "";

        return rows.map((row) => ({
          jugador: get(row, "jugador"),
          tipodemulta: get(row, "tipodemulta"),
          precio: parsePrice(get(row, "precio")),
          fechacreacion: parseDate(get(row, "fechacreacion")),
          status: String(get(row, "status") || ""),
        }));
      }

      createApp({
        data() {
          return {
            loading: false,
            error: "",
            parsedData: [],
          };
        },
        methods: {
          async load() {
            this.loading = true;
            this.error = "";
            try {
              const res = await fetch(CSV_URL, { cache: "no-store" });
              if (!res.ok) throw new Error("HTTP " + res.status);
              const text = await res.text();
              const papa = Papa.parse(text, {
                header: true,
                skipEmptyLines: true,
              });
              this.parsedData = rowsToObjects(papa);
            } catch (e) {
              this.error = String(e);
            } finally {
              this.loading = false;
            }
          },
        },
        mounted() {
          this.load();
        },
      }).mount("#app");
    </script>
  </body>
</html>
