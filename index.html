<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Multes Minguella - Senior A</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      #app {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin-bottom: 20px;
      }

      button:hover {
        background: #0056b3;
      }

      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      /* Tabla de jugadores */
      .players-table {
        margin-top: 20px;
      }

      .player-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
      }

      .player-row:hover {
        background: #f8f9fa;
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
      }

      .player-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .player-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #e9ecef;
      }

      .player-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .total-fines {
        text-align: right;
      }

      .amount {
        font-size: 20px;
        font-weight: 700;
        display: block;
      }

      .amount.low {
        color: #6c757d; /* Gris para 0-10‚Ç¨ */
      }

      .amount.medium {
        color: #ffc107; /* Amarillo para 11-25‚Ç¨ */
      }

      .amount.high {
        color: #fd7e14; /* Naranja para 26-40‚Ç¨ */
      }

      .amount.critical {
        color: #dc3545; /* Rojo para 41‚Ç¨+ */
      }

      .count {
        font-size: 14px;
        color: #6c757d;
      }

      /* Modal/Popup */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        width: 80%;
        max-width: 80%;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
      }

      .modal-header h3 {
        margin: 0;
        color: #333;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6c757d;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }

      .close-btn:hover {
        background: #e9ecef;
        color: #333;
      }

      .modal-body {
        padding: 20px;
        overflow-y: auto;
        max-height: 60vh;
      }

      /* Tabla de multas */
      .fines-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .fines-table th,
      .fines-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }

      .fines-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
      }

      .fines-table tbody tr:hover {
        background: #f8f9fa;
      }

      .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status.pendent {
        background: #fff3cd;
        color: #856404;
      }

      .status.pagada {
        background: #d4edda;
        color: #155724;
      }

      .status.anulada {
        background: #f8d7da;
        color: #721c24;
      }

      .total {
        font-size: 18px;
        color: #dc3545;
      }

      /* Tabla de todas las multas con filtros */
      .all-fines-section,
      .normes-section {
        margin-top: 40px;
        padding: 0 10px;
      }

      .norma {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-bottom: 10px;
        font-size: 14px;
        color: #6c757d;
        border-radius: 4px;
        padding: 10px;
        border: 1px solid #e9ecef;
      }

      .norma .exception {
        font-size: 10px;
        color: #721c24;
        border-radius: 10px;
        padding: 2px 5px;
        border: 1px solid #daacaf;
        background: #f8d7da;
        min-width: 75px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .section-header h3 {
        margin: 0;
      }

      .toggle-filters-btn {
        background: transparent;
        color: #6c757d;
        border: 1px solid #dee2e6;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        background: #f8f9fa;
      }

      .toggle-filters-btn:hover {
        background: #e9ecef;
        border-color: #adb5bd;
        color: #495057;
      }

      .toggle-filters-btn.expanded {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .toggle-filters-btn.expanded:hover {
        background: #0056b3;
        border-color: #0056b3;
      }

      .filters-container {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
      }

      .filters-container.visible {
        max-height: 200px;
        opacity: 1;
        margin-bottom: 20px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-group label {
        font-size: 12px;
        font-weight: 600;
        color: #495057;
      }

      .filter-group input,
      .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        min-width: 120px;
      }

      .filter-group input:focus,
      .filter-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .all-fines-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .table-container {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }

      .all-fines-table th,
      .all-fines-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }

      /* Columnas espec√≠ficas con min-width */
      .all-fines-table th:nth-child(3),
      .all-fines-table td:nth-child(3) {
        min-width: 150px; /* Tipus de multa */
      }

      .all-fines-table th:nth-child(4),
      .all-fines-table td:nth-child(4) {
        min-width: 200px; /* Comentari */
        font-size: 10px; /* Font-size m√°s peque√±o */
      }

      .all-fines-table th:nth-child(2),
      .all-fines-table td:nth-child(2) {
        min-width: 70px; /* Import */
      }

      .all-fines-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .all-fines-table tbody tr:hover {
        background: #f8f9fa;
      }

      .all-fines-table .amount {
        text-align: right;
        font-weight: 600;
      }

      .all-fines-table .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        text-align: center;
      }

      .all-fines-table .status.pendiente {
        background: #fff3cd;
        color: #856404;
      }

      .all-fines-table .status.pagada {
        background: #d4edda;
        color: #155724;
      }

      .all-fines-table .status.anulada {
        background: #f8d7da;
        color: #721c24;
      }

      .clear-filters-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-left: auto;
      }

      .clear-filters-btn:hover {
        background: #5a6268;
      }

      /* Estilos para el modal de nueva cena */
      .new-dinner-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 30px 0 20px 0;
        display: block;
        width: 100%;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
      }

      .new-dinner-btn:hover {
        background: #218838;
      }

      .dinner-modal-content {
        background: white;
        border-radius: 8px;
        width: 100%;
        max-width: 100%;
        max-height: 100vh;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
      }

      .dinner-modal-content .modal-body {
        max-height: unset;
        flex: 1;
        overflow-y: auto;
      }

      .dinner-input-group {
        margin-bottom: 20px;
      }

      .dinner-input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
      }

      .dinner-input-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 16px;
        max-width: 200px;
      }

      .dinner-input-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      .dinner-help-text {
        color: #6c757d;
        font-size: 14px;
        margin-bottom: 15px;
        font-style: italic;
      }

      .dinner-players-list {
        margin-bottom: 20px;
      }

      .dinner-player-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
      }

      .dinner-player-item .player-avatar {
        width: 40px;
        height: 40px;
      }

      .dinner-player-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .dinner-player-item.selected {
        border-color: #28a745;
        background: #f8fff9;
      }

      .dinner-player-item.not-selected {
        border: none;
        background: #e9ecef;
        opacity: 0.6;
      }

      .dinner-player-item.not-selected img {
        filter: grayscale(100%);
      }

      .dinner-player-item.not-selected .player-name,
      .dinner-player-item.not-selected .amount {
        color: #6c757d;
      }

      .dinner-results {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .dinner-results-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
      }

      .dinner-results-row:last-child {
        border-bottom: none;
      }

      .dinner-results-label {
        font-weight: 600;
        color: #495057;
      }

      .dinner-results-value {
        font-weight: 700;
        color: #333;
      }

      .dinner-player-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      .dinner-player-table th,
      .dinner-player-table td {
        padding: 6px 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }

      .dinner-player-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
      }

      .dinner-player-table tbody tr:hover {
        background: #f8f9fa;
      }

      .dinner-confirm-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        width: 100%;
        margin-top: 20px;
      }

      .dinner-confirm-btn:hover {
        background: #218838;
      }

      .dinner-confirm-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        #app {
          padding: 15px;
          margin: 10px;
        }

        h1 {
          font-size: 24px;
          margin-bottom: 20px;
        }

        h3 {
          font-size: 18px;
          margin-bottom: 15px;
        }

        .player-row {
          flex-direction: row;
          text-align: left;
          gap: 15px;
          padding: 15px;
          margin-bottom: 10px;
          align-items: center;
        }

        .player-info {
          flex-direction: row;
          gap: 12px;
          flex: 1;
        }

        .player-avatar {
          width: 50px;
          height: 50px;
        }

        .player-name {
          font-size: 16px;
        }

        .total-fines {
          text-align: right;
          flex-shrink: 0;
        }

        .amount {
          font-size: 18px;
        }

        .count {
          font-size: 12px;
        }

        .modal-content {
          margin: 20px;
          width: 98%;
          max-width: 98%;
          max-height: calc(100vh - 40px);
        }

        .modal-header {
          padding: 15px;
        }

        .modal-header h3 {
          font-size: 18px;
        }

        .modal-body {
          padding: 15px;
          max-height: 50vh;
        }

        .fines-table {
          font-size: 12px;
        }

        .fines-table th,
        .fines-table td {
          padding: 6px 4px;
          font-size: 12px;
        }

        .fines-table th {
          font-size: 11px;
        }

        .filters-container {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-group {
          min-width: auto;
        }

        .filter-group input,
        .filter-group select {
          min-width: auto;
        }

        .clear-filters-btn {
          margin-left: 0;
          margin-top: 10px;
        }

        .all-fines-table {
          font-size: 12px;
          min-width: 600px; /* Asegura que la tabla tenga un ancho m√≠nimo */
        }

        .all-fines-table th,
        .all-fines-table td {
          padding: 8px 6px;
          font-size: 12px;
        }

        .table-container {
          margin: 10px -10px; /* Extiende el scroll horizontal */
        }
      }

      @media (max-width: 480px) {
        #app {
          padding: 10px;
          margin: 5px;
        }

        .player-row {
          padding: 12px 8px;
          gap: 10px;
        }

        .player-info {
          gap: 8px;
        }

        .player-avatar {
          width: 45px;
          height: 45px;
        }

        .player-name {
          font-size: 15px;
        }

        .amount {
          font-size: 16px;
        }

        .count {
          font-size: 11px;
        }

        .fines-table {
          font-size: 11px;
        }

        .fines-table th,
        .fines-table td {
          padding: 4px 2px;
          font-size: 11px;
        }

        .all-fines-table {
          min-width: 500px;
        }

        .section-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .toggle-filters-btn {
          padding: 4px 8px;
          font-size: 11px;
        }

        .dinner-input-group input {
          max-width: 100%;
        }

        .dinner-player-item {
          padding: 10px;
        }

        .dinner-results-row {
          flex-direction: column;
          gap: 5px;
        }

        .dinner-player-table {
          font-size: 12px;
        }

        .dinner-player-table th,
        .dinner-player-table td {
          padding: 8px 6px;
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div style="text-align: center">
        <img
          style="width: 150px; height: 150px; object-fit: contain"
          src="https://res.cloudinary.com/srourera/image/upload/w_1000,ar_1:1,c_fill,g_auto,e_art:hokusai/v1756555944/minguella/agrupacio-esportiva-minguella-escut_eri68n.jpg"
        />
      </div>
      <h1>Multes Minguella - Senior A</h1>

      <div v-if="parsedData.length" id="app-content" style="visibility: hidden">
        <div v-if="error" class="error">Error: {{ error }}</div>
        <h3>Multes per Jugador</h3>

        <!-- Tabla agrupada por jugador -->
        <div class="players-table">
          <div
            v-for="player in playersWithFines"
            :key="player.name"
            class="player-row"
            @click="showPlayerDetails(player)"
          >
            <div class="player-info">
              <img :src="player.img" :alt="player.name" class="player-avatar" />
              <span class="player-name">{{ player.name }}</span>
            </div>
            <div class="total-fines">
              <span :class="['amount', getAmountClass(player.totalFines)]"
                >{{ player.totalFines.toFixed(2) }} ‚Ç¨</span
              >
              <span class="count">({{ player.pendingCount }} multes)</span>
            </div>
          </div>
        </div>

        <!-- Bot√≥n Nueva Cena -->
        <button @click="openDinnerModal" class="new-dinner-btn">
          üçΩÔ∏è Nueva cena
        </button>

        <!-- Listado de todas las multas con filtros -->
        <div class="all-fines-section">
          <div class="section-header" style="margin: 0">
            <h3 style="display: flex; flex-direction: column">
              Totes les Multes
              <a
                style="color: #ccc; font-size: 12px; margin: 0px"
                href="https://docs.google.com/spreadsheets/d/1fkCpZgF1BCl-_lOsB4O-MGofvkw6NBYAUIGd3aYWOyI/edit?gid=0#gid=0"
                target="_blank"
                >Excel</a
              >
            </h3>

            <!-- Bot√≥n para mostrar/ocultar filtros -->
            <button
              @click="toggleFilters"
              class="toggle-filters-btn"
              :class="{ 'expanded': filtersVisible }"
            >
              <span v-if="!filtersVisible">üîç Mostrar Filtres</span>
              <span v-else>üîç Ocultar Filtres</span>
            </button>
          </div>

          <!-- Filtros -->
          <div class="filters-container" :class="{ 'visible': filtersVisible }">
            <div class="filter-group">
              <label>Jugador</label>
              <input
                v-model="filters.jugador"
                type="text"
                placeholder="Filtrar per jugador..."
              />
            </div>

            <div class="filter-group">
              <label>Tipus de Multa</label>
              <input
                v-model="filters.tipodemulta"
                type="text"
                placeholder="Filtrar per tipus..."
              />
            </div>

            <div class="filter-group">
              <label>Comentari</label>
              <input
                v-model="filters.comment"
                type="text"
                placeholder="Filtrar per comentari..."
              />
            </div>

            <div class="filter-group">
              <label>Estat</label>
              <select v-model="filters.status">
                <option value="">Tots els estats</option>
                <option value="pendent">Pendent</option>
                <option value="pagada">Pagada</option>
                <option value="anulada">Anulada</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Data Desde</label>
              <input v-model="filters.fechaDesde" type="date" />
            </div>

            <div class="filter-group">
              <label>Data Fins</label>
              <input v-model="filters.fechaHasta" type="date" />
            </div>

            <button @click="clearFilters" class="clear-filters-btn">
              Netejar Filtres
            </button>
          </div>

          <!-- Tabla de todas las multas -->
          <div class="table-container">
            <table class="all-fines-table">
              <thead>
                <tr>
                  <th>Jugador</th>
                  <th>Import</th>
                  <th>Tipus de Multa</th>
                  <th>Comentari</th>
                  <th>Data</th>
                  <th>Estat</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="fine in reversedFilteredAllFines"
                  :key="fine.jugador + fine.tipodemulta + fine.fechacreacion"
                >
                  <td>{{ fine.jugador }}</td>
                  <td class="amount" style="color: #6c757d">
                    {{ fine.precio.toFixed(2) }} ‚Ç¨
                  </td>
                  <td>{{ fine.tipodemulta }}</td>
                  <td>{{ fine.comment }}</td>
                  <td>{{ formatDateForDisplay(fine.fechacreacion) }}</td>
                  <td>
                    <span :class="['status', fine.status.toLowerCase()]">
                      {{ fine.status }}
                    </span>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="1"><strong>Total:</strong></td>
                  <td class="amount total">
                    <strong style="color: black"
                      >{{ totalFilteredFines.toFixed(2) }} ‚Ç¨</strong
                    >
                  </td>
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Popup de detalle de multas -->
          <div
            v-if="selectedPlayer"
            class="modal-overlay"
            @click="closePlayerDetails"
          >
            <div class="modal-content" @click.stop>
              <div class="modal-header">
                <h3>Multes de {{ selectedPlayer.name }}</h3>
                <button class="close-btn" @click="closePlayerDetails">
                  &times;
                </button>
              </div>
              <div class="modal-body">
                <table class="fines-table">
                  <thead>
                    <tr>
                      <th>Tipus de Multa</th>
                      <th>Comentari</th>
                      <th>Import</th>
                      <th>Data</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      v-for="fine in selectedPlayer.fines"
                      :key="fine.tipodemulta + fine.fechacreacion"
                    >
                      <td style="font-size: 10px">{{ fine.tipodemulta }}</td>
                      <td style="font-size: 10px">{{ fine.comment }}</td>
                      <td
                        style="font-size: 10px; text-align: right"
                        class="amount"
                      >
                        {{ fine.precio.toFixed(2) }} ‚Ç¨
                      </td>
                      <td style="font-size: 10px">
                        {{ formatDateForDisplay(fine.fechacreacion) }}
                      </td>
                    </tr>
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="2"><strong>Total:</strong></td>
                      <td
                        style="text-align: right"
                        :class="['amount', 'total', getAmountClass(selectedPlayer.totalFines)]"
                      >
                        <strong
                          >{{ selectedPlayer.totalFines.toFixed(2) }} ‚Ç¨</strong
                        >
                      </td>
                      <td colspan="2"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Nueva Cena -->
        <div
          v-if="showDinnerModal"
          class="modal-overlay"
          @click="closeDinnerModal"
        >
          <div class="dinner-modal-content" @click.stop>
            <div class="modal-header">
              <h3>Nueva Cena</h3>
              <button class="close-btn" @click="closeDinnerModal">
                &times;
              </button>
            </div>
            <div class="modal-body">
              <!-- Input Precio por persona -->
              <div class="dinner-input-group">
                <label>Precio por persona (‚Ç¨)</label>
                <input
                  v-model.number="dinnerPricePerPerson"
                  type="number"
                  step="0.01"
                  min="0.01"
                  placeholder="Ej: 30"
                  required
                />
              </div>

              <!-- Listado de jugadores -->
              <h4 style="margin-top: 20px; margin-bottom: 10px">Jugadores</h4>
              <p class="dinner-help-text">
                Haz click para cambiar qui√©n asiste a la cena
              </p>

              <div class="dinner-players-list">
                <!-- Jugadores seleccionados -->
                <div
                  v-for="player in selectedDinnerPlayers"
                  :key="player.name"
                  class="dinner-player-item selected"
                  @click="toggleDinnerPlayer(player.name)"
                >
                  <div class="player-info">
                    <img
                      :src="player.img"
                      :alt="player.name"
                      class="player-avatar"
                    />
                    <span class="player-name">{{ player.name }}</span>
                  </div>
                  <div class="total-fines">
                    <span class="amount"
                      >{{ player.totalFines.toFixed(2) }} ‚Ç¨</span
                    >
                  </div>
                </div>

                <!-- Jugadores no seleccionados -->
                <div
                  v-for="player in unselectedDinnerPlayers"
                  :key="player.name"
                  class="dinner-player-item not-selected"
                  @click="toggleDinnerPlayer(player.name)"
                >
                  <div class="player-info">
                    <img
                      :src="player.img"
                      :alt="player.name"
                      class="player-avatar"
                    />
                    <span class="player-name">{{ player.name }}</span>
                  </div>
                  <div class="total-fines">
                    <span class="amount"
                      >{{ player.totalFines.toFixed(2) }} ‚Ç¨</span
                    >
                  </div>
                </div>
              </div>

              <!-- Resultados din√°micos -->
              <div class="dinner-results">
                <div class="dinner-results-row">
                  <span class="dinner-results-label">Total de multas:</span>
                  <span class="dinner-results-value"
                    >{{ totalDinnerFines.toFixed(2) }} ‚Ç¨</span
                  >
                </div>
                <div class="dinner-results-row">
                  <span class="dinner-results-label">Total de la cena:</span>
                  <span class="dinner-results-value"
                    >{{ totalDinnerCost.toFixed(2) }} ‚Ç¨</span
                  >
                </div>
                <div class="dinner-results-row">
                  <span class="dinner-results-label"
                    >Importe de cena pendiente:</span
                  >
                  <span
                    class="dinner-results-value"
                    :style="dinnerPendingStyle"
                  >
                    {{ dinnerPendingText }}
                  </span>
                </div>
                <div class="dinner-results-row">
                  <span class="dinner-results-label"
                    >Importe extra por persona:</span
                  >
                  <span
                    class="dinner-results-value"
                    :style="dinnerExtraPerPersonStyle"
                  >
                    {{ dinnerExtraPerPersonText }}
                  </span>
                </div>
              </div>

              <!-- Tabla por jugador -->
              <h4 style="margin-top: 20px; margin-bottom: 10px">
                Listado por jugador
              </h4>
              <table class="dinner-player-table">
                <thead>
                  <tr>
                    <th>Jugador</th>
                    <th>Multa</th>
                    <th>Cena extra por persona</th>
                    <th>Total a pagar</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="player in selectedDinnerPlayers"
                    :key="player.name"
                  >
                    <td>{{ player.name }}</td>
                    <td>{{ player.totalFines.toFixed(2) }} ‚Ç¨</td>
                    <td>{{ getExtraPerPerson(player.name).toFixed(2) }} ‚Ç¨</td>
                    <td>
                      <strong
                        >{{ ( player.totalFines + getExtraPerPerson(player.name)
                        ).toFixed(2) }} ‚Ç¨</strong
                      >
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- Bot√≥n confirmar -->
              <button
                @click="confirmDinner"
                class="dinner-confirm-btn"
                :disabled="!canConfirmDinner"
              >
                Confirmar cena y marcar multas como pagadas
              </button>
            </div>
          </div>
        </div>

        <div class="normes-section">
          <h3>Normes</h3>
          <div v-for="(norma, index) in normes" :key="index" class="norma">
            {{ norma.Norma }}
            <div v-if="norma.Excepcio">
              <span class="exception">Excepci√≥: {{ norma.Excepcio }}</span>
            </div>
          </div>
        </div>
      </div>
      <!-- PapaParse para CSV robusto -->
      <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
      <!-- Vue 3 por CDN -->
      <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

      <script>
        const { createApp } = Vue;

        // üîß Sustituye por tu Sheet y pesta√±a
        const SHEET_ID = "1fkCpZgF1BCl-_lOsB4O-MGofvkw6NBYAUIGd3aYWOyI";
        const GID = "0";
        const GID_JUGADORS = "1534873034";
        const GID_NORMES = "666064212";
        const MULTES_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
        const JUGADORS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_JUGADORS}`;
        const NORMES_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_NORMES}`;

        // Utilidades
        const parsePrice = (v) => {
          if (v == null) return 0;
          const s = String(v).trim().replace(/[‚Ç¨\s]/g, "").replace(",", ".");
          const n = parseFloat(s);
          return Number.isFinite(n) ? n : 0;
        };

        const normalizeHeader = (s) =>
          String(s || "")
            .trim()
            .toLowerCase();

        const parseDate = (v) => {
          return v.split(" ")[0];
        };

        function rowsToObjects(papaResult) {
          const rows = papaResult.data || [];
          if (!rows.length) return [];
          const headerMap = {};
          Object.keys(rows[0]).forEach((k) => {
            headerMap[normalizeHeader(k)] = k;
          });

          const get = (row, logical) => row[headerMap[logical]] ?? "";

          return rows.map((row) => {
            const fecha = parseDate(get(row, "fecha creaci√≥n"));
            return {
              jugador: get(row, "jugador"),
              tipodemulta: get(row, "tipo de multa"),
              precio: parsePrice(get(row, "importe")),
              comment: get(row, "comentario"),
              fechacreacion: fecha,
              status: String(get(row, "estado") || ""),
            };
          });
        }

        createApp({
          data() {
            return {
              loading: false,
              error: "",
              parsedData: [],
              players: [],
              normes: [],
              selectedPlayer: null, // Para el popup de detalle
              filters: {
                jugador: "",
                tipodemulta: "",
                comment: "",
                status: "pendent",
                fechaDesde: "",
                fechaHasta: "",
              },
              filtersVisible: false,
              // Datos para el modal de cena
              showDinnerModal: false,
              dinnerPricePerPerson: 30,
              selectedDinnerPlayerNames: [], // Array de nombres de jugadores seleccionados
            };
          },
          computed: {
            playersWithFines() {
              const playersMap = {};
              this.players.forEach((player) => {
                playersMap[player.Nom] = {
                  name: player.Nom,
                  img: player.Foto,
                  fines: [],
                  totalFines: 0,
                  pendingCount: 0,
                };
              });

              // Procesar las multas existentes
              this.parsedData.forEach((fine) => {
                const playerName = fine.jugador;
                // Solo procesar si el jugador est√° en PLAYERS
                if (playersMap[playerName]) {
                  // Solo agregar multas pendientes al array de multas
                  if (fine.status.toLowerCase() === "pendent") {
                    playersMap[playerName].fines.push(fine);
                    playersMap[playerName].pendingCount++;
                    playersMap[playerName].totalFines += fine.precio;
                  }
                }
              });

              // Retornar todos los jugadores ordenados por multa total
              return Object.values(playersMap).sort(
                (a, b) => b.totalFines - a.totalFines
              );
            },
            reversedFilteredAllFines() {
              return [...this.filteredAllFines].reverse();
            },
            filteredAllFines() {
              return this.parsedData.filter((fine) => {
                // Filtro por jugador
                if (
                  this.filters.jugador &&
                  !fine.jugador
                    .toLowerCase()
                    .includes(this.filters.jugador.toLowerCase())
                ) {
                  return false;
                }

                // Filtro por tipo de multa
                if (
                  this.filters.tipodemulta &&
                  !fine.tipodemulta
                    .toLowerCase()
                    .includes(this.filters.tipodemulta.toLowerCase())
                ) {
                  return false;
                }

                // Filtro por comentario
                if (
                  this.filters.comment &&
                  !fine.comment
                    .toLowerCase()
                    .includes(this.filters.comment.toLowerCase())
                ) {
                  return false;
                }

                // Filtro por estado
                if (
                  this.filters.status &&
                  fine.status.toLowerCase() !==
                    this.filters.status.toLowerCase()
                ) {
                  return false;
                }

                // Filtro por fecha desde
                if (
                  this.filters.fechaDesde &&
                  fine.fechacreacion < this.filters.fechaDesde
                ) {
                  return false;
                }

                // Filtro por fecha hasta
                if (
                  this.filters.fechaHasta &&
                  fine.fechacreacion > this.filters.fechaHasta
                ) {
                  return false;
                }

                return true;
              });
            },

            totalFilteredFines() {
              return this.filteredAllFines.reduce(
                (total, fine) => total + fine.precio,
                0
              );
            },
            // Computed para jugadores de cena
            selectedDinnerPlayers() {
              return this.playersWithFines
                .filter((p) => this.selectedDinnerPlayerNames.includes(p.name))
                .sort((a, b) => b.totalFines - a.totalFines);
            },
            unselectedDinnerPlayers() {
              return this.playersWithFines.filter(
                (p) => !this.selectedDinnerPlayerNames.includes(p.name)
              );
            },
            // C√°lculos de cena
            totalDinnerFines() {
              return this.selectedDinnerPlayers.reduce(
                (total, player) => total + player.totalFines,
                0
              );
            },
            totalDinnerCost() {
              if (
                !this.dinnerPricePerPerson ||
                this.selectedDinnerPlayers.length === 0
              ) {
                return 0;
              }
              return (
                this.dinnerPricePerPerson * this.selectedDinnerPlayers.length
              );
            },
            dinnerPendingAmount() {
              return this.totalDinnerCost - this.totalDinnerFines;
            },
            dinnerPendingText() {
              const amount = Math.abs(this.dinnerPendingAmount);
              if (this.dinnerPendingAmount > 0) {
                return `Faltan ${amount.toFixed(2)}‚Ç¨`;
              } else if (this.dinnerPendingAmount < 0) {
                return `Sobran ${amount.toFixed(2)}‚Ç¨`;
              }
              return "0.00‚Ç¨";
            },
            dinnerPendingStyle() {
              if (this.dinnerPendingAmount > 0) {
                return { color: "#dc3545" };
              } else if (this.dinnerPendingAmount < 0) {
                return { color: "#28a745" };
              }
              return { color: "#333" };
            },
            dinnerExtraPerPerson() {
              if (this.selectedDinnerPlayers.length === 0) {
                return 0;
              }
              const extra =
                this.dinnerPendingAmount / this.selectedDinnerPlayers.length;
              // Redondear siempre a la alza a 1 decimal
              return Math.ceil(extra * 10) / 10;
            },
            dinnerExtraPerPersonText() {
              const amount = Math.abs(this.dinnerExtraPerPerson);
              if (this.dinnerExtraPerPerson > 0) {
                return `Faltan ${Number(amount.toFixed(1)).toFixed(
                  2
                )}‚Ç¨ por persona`;
              } else if (this.dinnerExtraPerPerson < 0) {
                return `Sobran ${amount.toFixed(2)}‚Ç¨ por persona`;
              }
              return "0.0‚Ç¨ por persona";
            },
            dinnerExtraPerPersonStyle() {
              if (this.dinnerExtraPerPerson > 0) {
                return { color: "#dc3545" };
              } else if (this.dinnerExtraPerPerson < 0) {
                return { color: "#28a745" };
              }
              return { color: "#333" };
            },
            canConfirmDinner() {
              return (
                this.dinnerPricePerPerson &&
                this.dinnerPricePerPerson > 0 &&
                this.selectedDinnerPlayers.length > 0
              );
            },
          },
          methods: {
            async loadNormes() {
              try {
                const res = await fetch(NORMES_URL);
                if (!res.ok) throw new Error("HTTP " + res.status);
                const text = await res.text();
                const papa = Papa.parse(text, {
                  header: true,
                  skipEmptyLines: true,
                });
                this.normes = papa.data;
              } catch (e) {
                this.error = String(e);
              }
            },
            async loadPlayers() {
              try {
                const res = await fetch(JUGADORS_URL);
                if (!res.ok) throw new Error("HTTP " + res.status);
                const text = await res.text();
                const papa = Papa.parse(text, {
                  header: true,
                  skipEmptyLines: true,
                });
                this.players = papa.data;
              } catch (e) {
                this.error = String(e);
              }
            },
            async load() {
              this.loading = true;
              this.error = "";
              try {
                const res = await fetch(MULTES_URL, { cache: "no-store" });
                if (!res.ok) throw new Error("HTTP " + res.status);
                const text = await res.text();
                const papa = Papa.parse(text, {
                  header: true,
                  skipEmptyLines: true,
                });
                this.parsedData = rowsToObjects(papa);
                await this.loadPlayers();
                this.loadNormes();
              } catch (e) {
                this.error = String(e);
              } finally {
                this.loading = false;
              }
            },
            showPlayerDetails(player) {
              this.selectedPlayer = player;
            },
            closePlayerDetails() {
              this.selectedPlayer = null;
            },
            formatDateForDisplay(dateString) {
              return dateString; //.slice(0, 10);
            },

            clearFilters() {
              this.filters = {
                jugador: "",
                tipodemulta: "",
                comment: "",
                status: "Pendent",
                fechaDesde: "",
                fechaHasta: "",
              };
            },

            toggleFilters() {
              this.filtersVisible = !this.filtersVisible;
            },

            getAmountClass(amount) {
              if (amount <= 10) return "low";
              if (amount <= 25) return "medium";
              if (amount <= 40) return "high";
              return "critical";
            },
            // M√©todos para el modal de cena
            openDinnerModal() {
              // Inicializar con todos los jugadores seleccionados
              if (this.selectedDinnerPlayerNames?.length === 0)
                this.selectedDinnerPlayerNames = this.playersWithFines.map(
                  (p) => p.name
                );
              if (!this.dinnerPricePerPerson) this.dinnerPricePerPerson = 30;
              this.showDinnerModal = true;
              // Quitar el scroll del body cuando se abre el modal
              document.body.style.overflow = "hidden";
            },
            closeDinnerModal() {
              this.showDinnerModal = false;
              // Restaurar el scroll del body cuando se cierra el modal
              document.body.style.overflow = "";
            },
            toggleDinnerPlayer(playerName) {
              const index = this.selectedDinnerPlayerNames.indexOf(playerName);
              if (index > -1) {
                // Deseleccionar
                this.selectedDinnerPlayerNames.splice(index, 1);
              } else {
                // Seleccionar
                this.selectedDinnerPlayerNames.push(playerName);
              }
            },
            getExtraPerPerson(playerName) {
              // Si el extra es negativo, retornar 0
              if (this.dinnerExtraPerPerson < 0) {
                return 0;
              }
              return this.dinnerExtraPerPerson;
            },
            async confirmDinner() {
              if (!this.canConfirmDinner) {
                return;
              }

              try {
                const response = await fetch(
                  "https://n8n.ridaflows.com/webhook/minguella/marcar-multas-pagadas",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      jugadores: this.selectedDinnerPlayerNames,
                    }),
                  }
                );

                if (!response.ok) {
                  throw new Error("Error al confirmar la cena");
                }

                // Cerrar el popup
                this.closeDinnerModal();

                // Recargar la p√°gina
                window.location.reload();
              } catch (error) {
                this.error = `Error al confirmar la cena: ${error.message}`;
                alert(this.error);
              }
            },
          },
          async mounted() {
            await this.load();
            document.getElementById("app-content").style.visibility = "visible";
          },
        }).mount("#app");
      </script>
    </div>
  </body>
</html>
